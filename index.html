<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3é’±åŒ…åœ°å€éªŒè¯å™¨ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --primary: #8b5cf6;
            --success: #22c55e;
            --error: #ef4444;
            --border: #334155;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 480px;
            text-align: center;
            border: 1px solid var(--border);
        }

        h2 { margin-top: 0; margin-bottom: 0.5rem; font-weight: 600; }
        p.subtitle { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 2rem; }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }

        input {
            width: 100%;
            padding: 14px 16px;
            padding-right: 40px;
            background-color: #0f172a;
            border: 2px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
            font-family: monospace;
        }
        input:focus { outline: none; border-color: var(--primary); }

        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-sub);
            display: none;
            line-height: 1;
            padding: 5px;
            z-index: 2;
        }
        .clear-btn:hover { color: var(--text-main); }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s; /* å¢åŠ é€æ˜åº¦è¿‡æ¸¡ */
        }
        button:hover { background-color: #7c3aed; }
        
        /* æŒ‰é’®ç¦ç”¨çŠ¶æ€æ ·å¼ */
        button:disabled {
            background-color: var(--border);
            cursor: not-allowed;
            opacity: 0.7;
        }

        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
            font-size: 0.95rem;
            text-align: left;
            word-break: break-all;
        }

        /* --- æ–°å¢ï¼šæ·¡å…¥åŠ¨ç”» --- */
        @keyframes fadeInMove {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-animate {
            animation: fadeInMove 0.4s ease-out forwards;
        }

        .result-valid {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .result-invalid {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .chain-tag {
            display: inline-block;
            padding: 2px 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
            color: var(--text-main);
            vertical-align: middle;
        }

        .tech-note {
            font-size: 0.75rem;
            display: block;
            margin-top: 5px;
            opacity: 0.8;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Web3 é’±åŒ…åœ°å€æ ¡éªŒ</h2>
    <p class="subtitle">æ”¯æŒ EVM, Solana, Bitcoin, <strong>Tron (å¼ºæ ¡éªŒ)</strong></p>

    <div class="input-group">
        <input type="text" id="addressInput" placeholder="è¾“å…¥é’±åŒ…åœ°å€ (0x..., T...)" autocomplete="off">
        <span id="clearBtn" class="clear-btn">Ã—</span>
    </div>

    <button id="checkBtn" onclick="startCheck()">éªŒè¯åœ°å€</button>

    <div id="result"></div>
</div>

<script>
    // ================= 1. Google è¡¨å•é…ç½® (ä¿ç•™åŸæœ‰åŠŸèƒ½) =================
    // ã€è¯·åœ¨æ­¤å¤„å¡«å›æ‚¨çš„ Google IDã€‘
    const GOOGLE_CONFIG = {
        url: "https://docs.google.com/forms/d/e/1FAIpQLSd9tGfPqfi-oOrtZhGQZP7qfcN1P3TS4orJSgbWTjf750PDQQ/formResponse",
        fields: {
            address: "entry.722471",
            chain:   "entry.2095444141",
            result:  "entry.754674652",
            device:  "entry.66311598"
        }
    };

    // ================= 2. Cloudflare Workers é…ç½® =================
    // ã€è¯·åœ¨æ­¤å¤„å¡«å›æ‚¨çš„ Worker URLï¼Œæ³¨æ„è¦åŠ  https://ã€‘
    const WORKER_CONFIG = {
        url: "https://web3addresschecker.ymxc.dpdns.org" 
    };
    // ================================================================

    const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    const ALPHABET_MAP = {};
    for(let i = 0; i < ALPHABET.length; i++) ALPHABET_MAP[ALPHABET.charAt(i)] = i;

    function base58Decode(string) {
        if (string.length === 0) return new Uint8Array(0);
        let i, j, bytes = [0];
        for (i = 0; i < string.length; i++) {
            const c = string[i];
            if (!(c in ALPHABET_MAP)) return null;
            for (j = 0; j < bytes.length; j++) bytes[j] *= 58;
            bytes[0] += ALPHABET_MAP[c];
            let carry = 0;
            for (j = 0; j < bytes.length; ++j) {
                bytes[j] += carry;
                carry = bytes[j] >> 8;
                bytes[j] &= 0xff;
            }
            while (carry) {
                bytes.push(carry & 0xff);
                carry >>= 8;
            }
        }
        for (i = 0; i < string.length && string[i] === '1'; i++) bytes.push(0);
        return new Uint8Array(bytes.reverse());
    }

    // --- æ–°å¢ï¼šä¸“é—¨æ§åˆ¶ UI æµç¨‹çš„å‡½æ•° ---
    function startCheck() {
        const input = document.getElementById('addressInput').value.trim();
        const resultDiv = document.getElementById('result');
        const btn = document.getElementById('checkBtn');

        // 1. å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œä¸è¿›è¡ŒåŠ¨ç”»ï¼Œç›´æ¥æç¤º
        if (!input) {
            checkAddress(input);
            return;
        }

        // 2. UI å˜èº«ï¼šæŒ‰é’®ç¦ç”¨ï¼Œæ˜¾ç¤º loading
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerText = "ğŸ”„ æ£€æµ‹ä¸­...";
        
        // 3. ç«‹å³éšè—æ—§ç»“æœ (è®©ç”¨æˆ·æ„Ÿè§‰åˆ°å˜åŒ–)
        resultDiv.style.display = 'none';
        resultDiv.className = ''; 

        // 4. äººä¸ºå»¶è¿Ÿ 500 æ¯«ç§’ï¼Œåˆ¶é€ "æ­£åœ¨è®¡ç®—"çš„æ„Ÿè§‰
        setTimeout(() => {
            checkAddress(input);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.disabled = false;
            btn.innerText = originalText;
        }, 500); // è¿™é‡Œæ˜¯ 0.5 ç§’ï¼Œæ‚¨å¯ä»¥éšæ„è°ƒæ•´
    }

    async function checkAddress(input) {
        // const input = ... (å·²ç»é€šè¿‡å‚æ•°ä¼ è¿›æ¥äº†)
        // const resultDiv = ... (åœ¨ showResult é‡Œè·å–)

        if (!input) {
            showResult(false, "è¯·è¾“å…¥åœ°å€", "N/A", "ç©ºè¾“å…¥");
            return;
        }

        // 1. EVM
        if (ethers.isAddress(input)) {
            showResult(true, "æœ‰æ•ˆçš„ EVM åœ°å€", "ETH/BSC/L2", "é€šè¿‡ Checksum æ ¡éªŒ");
            return;
        }

        // 2. Tron
        if (input.startsWith('T')) {
            const tronValid = await verifyTronAddress(input);
            if (tronValid) {
                showResult(true, "æœ‰æ•ˆçš„ Tron åœ°å€", "Tron (TRC20)", "é€šè¿‡ Checksum åŒé‡å“ˆå¸Œæ ¡éªŒ");
            } else {
                showResult(false, "æ— æ•ˆçš„ Tron åœ°å€", "Tron", "Base58è§£ç å¤±è´¥æˆ–å“ˆå¸Œæ ¡éªŒé”™è¯¯");
            }
            return;
        }

        // 3. Solana
        const solanaRegex = /^[1-9A-HJ-NP-Za-km-z]{32,44}$/;
        if (solanaRegex.test(input)) {
            showResult(true, "æ ¼å¼ç¬¦åˆ Solana åœ°å€", "Solana", "æ­£åˆ™æ ¡éªŒé€šè¿‡");
            return;
        }

        // 4. Bitcoin
        const btcRegex = /^(1|3|bc1)[a-zA-Z0-9]{25,59}$/;
        if (btcRegex.test(input)) {
            showResult(true, "æ ¼å¼ç¬¦åˆ Bitcoin åœ°å€", "Bitcoin", "æ­£åˆ™æ ¡éªŒé€šè¿‡");
            return;
        }

        showResult(false, "æ— æ³•è¯†åˆ«çš„åœ°å€æ ¼å¼", "Unknown", "æ ¼å¼æœªçŸ¥");
    }

    async function verifyTronAddress(address) {
        try {
            const decoded = base58Decode(address);
            if (!decoded || decoded.length !== 25) return false;
            if (decoded[0] !== 0x41) return false;

            const dataContent = decoded.slice(0, 21);
            const originalChecksum = decoded.slice(21);
            const firstHash = ethers.sha256(dataContent); 
            const secondHash = ethers.sha256(firstHash);
            const calculatedChecksumBytes = ethers.getBytes(secondHash).slice(0, 4);

            return (calculatedChecksumBytes[0] === originalChecksum[0] &&
                    calculatedChecksumBytes[1] === originalChecksum[1] &&
                    calculatedChecksumBytes[2] === originalChecksum[2] &&
                    calculatedChecksumBytes[3] === originalChecksum[3]);
        } catch (e) { return false; }
    }

    function showResult(isValid, displayMessage, chain, techDetails) {
        const resultDiv = document.getElementById('result');
        const inputVal = document.getElementById('addressInput').value.trim();
        
        resultDiv.style.display = 'block';
        
        // --- æ–°å¢ï¼šæ¯æ¬¡æ˜¾ç¤ºç»“æœæ—¶ï¼Œç§»é™¤å†æ·»åŠ  class ä»¥è§¦å‘åŠ¨ç”» ---
        resultDiv.classList.remove('result-animate');
        void resultDiv.offsetWidth; // è§¦å‘æµè§ˆå™¨é‡ç»˜ (Magic trick)
        resultDiv.classList.add('result-animate');

        if (isValid) {
            resultDiv.className = 'result-valid result-animate'; // åŠ ä¸ŠåŠ¨ç”»ç±»
            let html = `<strong>âœ… éªŒè¯é€šè¿‡:</strong> ${displayMessage}`;
            if (chain && chain !== "Unknown") html += `<span class="chain-tag">${chain}</span>`;
            if (techDetails) html += `<span class="tech-note">â„¹ï¸ ${techDetails}</span>`;
            resultDiv.innerHTML = html;
        } else {
            resultDiv.className = 'result-invalid result-animate'; // åŠ ä¸ŠåŠ¨ç”»ç±»
            let html = `<strong>âŒ éªŒè¯å¤±è´¥:</strong> ${displayMessage}`;
            if (techDetails) html += `<span class="tech-note">â„¹ï¸ åŸå› : ${techDetails}</span>`;
            resultDiv.innerHTML = html;
        }

        const finalStatus = isValid ? "âœ… æœ‰æ•ˆ" : `âŒ æ— æ•ˆ (${techDetails})`;
        
        // å¹¶è¡Œä¸Šä¼ æ—¥å¿—
        logToGoogle(inputVal, chain, finalStatus);
        logToCloudflare(inputVal, chain, finalStatus);
    }

    function logToGoogle(address, chain, status) {
        if(!GOOGLE_CONFIG.url.includes("docs.google.com")) return; 
        
        const deviceInfo = `${navigator.userAgent} | Lang: ${navigator.language}`;
        const formData = new FormData();
        formData.append(GOOGLE_CONFIG.fields.address, address);
        formData.append(GOOGLE_CONFIG.fields.chain, chain);
        formData.append(GOOGLE_CONFIG.fields.result, status);
        if(GOOGLE_CONFIG.fields.device) {
            formData.append(GOOGLE_CONFIG.fields.device, deviceInfo);
        }

        fetch(GOOGLE_CONFIG.url, { method: "POST", mode: "no-cors", body: formData })
            .catch(e => console.error("Google Log Error:", e));
    }

    function logToCloudflare(address, chain, status) {
        if (!WORKER_CONFIG.url || WORKER_CONFIG.url === "") return;

        const deviceInfo = `${navigator.userAgent} | Lang: ${navigator.language}`;
        const data = {
            address: address,
            chain: chain,
            result: status,
            device: deviceInfo
        };

        fetch(WORKER_CONFIG.url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(res => {
            if(!res.ok) console.warn("Cloudflare Log Failed:", res.status);
        })
        .catch(err => console.error("Cloudflare Connection Error:", err));
    }

    const addressInput = document.getElementById('addressInput');
    const clearBtn = document.getElementById('clearBtn');
    const resultDiv = document.getElementById('result');

    addressInput.addEventListener('input', function() {
        clearBtn.style.display = this.value.length > 0 ? 'block' : 'none';
    });

    clearBtn.addEventListener('click', function() {
        addressInput.value = '';
        clearBtn.style.display = 'none';
        resultDiv.style.display = 'none';
        addressInput.focus();
    });

    if (addressInput.value.length > 0) clearBtn.style.display = 'block';

    addressInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") startCheck(); // è¿™é‡Œæ”¹æˆè°ƒç”¨ startCheck
    });
</script>

</body>
</html>
