<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 钱包地址验证器 (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --primary: #8b5cf6;
            --success: #22c55e;
            --error: #ef4444;
            --border: #334155;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 480px;
            text-align: center;
            border: 1px solid var(--border);
        }

        h2 { margin-top: 0; margin-bottom: 0.5rem; font-weight: 600; }
        p.subtitle { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 2rem; }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }

        input {
            width: 100%;
            padding: 14px 16px;
            padding-right: 40px;
            background-color: #0f172a;
            border: 2px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
            font-family: monospace;
        }
        input:focus { outline: none; border-color: var(--primary); }

        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-sub);
            display: none;
            line-height: 1;
            padding: 5px;
            z-index: 2;
        }
        .clear-btn:hover { color: var(--text-main); }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #7c3aed; }

        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
            font-size: 0.95rem;
            text-align: left;
            word-break: break-all;
        }

        .result-valid {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .result-invalid {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .chain-tag {
            display: inline-block;
            padding: 2px 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
            color: var(--text-main);
            vertical-align: middle;
        }

        .tech-note {
            font-size: 0.75rem;
            display: block;
            margin-top: 5px;
            opacity: 0.8;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Web3 钱包地址校验</h2>
    <p class="subtitle">支持 EVM, Solana, Bitcoin, <strong>Tron (强校验)</strong></p>

    <div class="input-group">
        <input type="text" id="addressInput" placeholder="输入钱包地址 (0x..., T...)" autocomplete="off">
        <span id="clearBtn" class="clear-btn">×</span>
    </div>

    <button onclick="checkAddress()">验证地址</button>

    <div id="result"></div>
</div>

<script>
    // ================= 1. Google 表单配置 (保留原有功能) =================
    const GOOGLE_CONFIG = {
        url: "https://docs.google.com/forms/d/e/1FAIpQLSd9tGfPqfi-oOrtZhGQZP7qfcN1P3TS4orJSgbWTjf750PDQQ/formResponse",
        fields: {
            address: "entry.722471",
            chain:   "entry.2095444141",
            result:  "entry.754674652",
            device:  "entry.66311598"
        }
    };

    // ================= 2. Cloudflare Workers 配置 (新增功能) =================
    // 如果您部署了 Worker，请在下方填入 URL。
    // 如果还没部署，留空即可，代码会自动跳过，不影响 Google 表单的使用。
    const WORKER_CONFIG = {
        url: "https://web3addresschecker.ymxc.dpdns.org" // 例如: "https://web3-logger.您的用户名.workers.dev"
    };
    // ======================================================================

    const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    const ALPHABET_MAP = {};
    for(let i = 0; i < ALPHABET.length; i++) ALPHABET_MAP[ALPHABET.charAt(i)] = i;

    function base58Decode(string) {
        if (string.length === 0) return new Uint8Array(0);
        let i, j, bytes = [0];
        for (i = 0; i < string.length; i++) {
            const c = string[i];
            if (!(c in ALPHABET_MAP)) return null;
            for (j = 0; j < bytes.length; j++) bytes[j] *= 58;
            bytes[0] += ALPHABET_MAP[c];
            let carry = 0;
            for (j = 0; j < bytes.length; ++j) {
                bytes[j] += carry;
                carry = bytes[j] >> 8;
                bytes[j] &= 0xff;
            }
            while (carry) {
                bytes.push(carry & 0xff);
                carry >>= 8;
            }
        }
        for (i = 0; i < string.length && string[i] === '1'; i++) bytes.push(0);
        return new Uint8Array(bytes.reverse());
    }

    async function checkAddress() {
        const input = document.getElementById('addressInput').value.trim();
        const resultDiv = document.getElementById('result');
        
        resultDiv.style.display = 'none';
        resultDiv.className = '';
        
        if (!input) {
            showResult(false, "请输入地址", "N/A", "空输入");
            return;
        }

        // 1. EVM
        if (ethers.isAddress(input)) {
            showResult(true, "有效的 EVM 地址", "ETH/BSC/L2", "通过 Checksum 校验");
            return;
        }

        // 2. Tron
        if (input.startsWith('T')) {
            const tronValid = await verifyTronAddress(input);
            if (tronValid) {
                showResult(true, "有效的 Tron 地址", "Tron (TRC20)", "通过 Checksum 双重哈希校验");
            } else {
                showResult(false, "无效的 Tron 地址", "Tron", "Base58解码失败或哈希校验错误");
            }
            return;
        }

        // 3. Solana
        const solanaRegex = /^[1-9A-HJ-NP-Za-km-z]{32,44}$/;
        if (solanaRegex.test(input)) {
            showResult(true, "格式符合 Solana 地址", "Solana", "正则校验通过");
            return;
        }

        // 4. Bitcoin
        const btcRegex = /^(1|3|bc1)[a-zA-Z0-9]{25,59}$/;
        if (btcRegex.test(input)) {
            showResult(true, "格式符合 Bitcoin 地址", "Bitcoin", "正则校验通过");
            return;
        }

        showResult(false, "无法识别的地址格式", "Unknown", "格式未知");
    }

    async function verifyTronAddress(address) {
        try {
            const decoded = base58Decode(address);
            if (!decoded || decoded.length !== 25) return false;
            if (decoded[0] !== 0x41) return false;

            const dataContent = decoded.slice(0, 21);
            const originalChecksum = decoded.slice(21);
            const firstHash = ethers.sha256(dataContent); 
            const secondHash = ethers.sha256(firstHash);
            const calculatedChecksumBytes = ethers.getBytes(secondHash).slice(0, 4);

            return (calculatedChecksumBytes[0] === originalChecksum[0] &&
                    calculatedChecksumBytes[1] === originalChecksum[1] &&
                    calculatedChecksumBytes[2] === originalChecksum[2] &&
                    calculatedChecksumBytes[3] === originalChecksum[3]);
        } catch (e) { return false; }
    }

    function showResult(isValid, displayMessage, chain, techDetails) {
        const resultDiv = document.getElementById('result');
        const inputVal = document.getElementById('addressInput').value.trim();
        
        resultDiv.style.display = 'block';
        
        if (isValid) {
            resultDiv.className = 'result-valid';
            let html = `<strong>✅ 验证通过:</strong> ${displayMessage}`;
            if (chain && chain !== "Unknown") html += `<span class="chain-tag">${chain}</span>`;
            if (techDetails) html += `<span class="tech-note">ℹ️ ${techDetails}</span>`;
            resultDiv.innerHTML = html;
        } else {
            resultDiv.className = 'result-invalid';
            let html = `<strong>❌ 验证失败:</strong> ${displayMessage}`;
            if (techDetails) html += `<span class="tech-note">ℹ️ 原因: ${techDetails}</span>`;
            resultDiv.innerHTML = html;
        }

        const finalStatus = isValid ? "✅ 有效" : `❌ 无效 (${techDetails})`;
        
        // --- 核心修改：同时调用两个日志系统 ---
        logToGoogle(inputVal, chain, finalStatus);
        logToCloudflare(inputVal, chain, finalStatus);
    }

    // --- 通道 1: Google Form 记录 ---
    function logToGoogle(address, chain, status) {
        if(!GOOGLE_CONFIG.url.includes("docs.google.com")) return; 
        
        const deviceInfo = `${navigator.userAgent} | Lang: ${navigator.language}`;
        const formData = new FormData();
        formData.append(GOOGLE_CONFIG.fields.address, address);
        formData.append(GOOGLE_CONFIG.fields.chain, chain);
        formData.append(GOOGLE_CONFIG.fields.result, status);
        if(GOOGLE_CONFIG.fields.device) {
            formData.append(GOOGLE_CONFIG.fields.device, deviceInfo);
        }

        fetch(GOOGLE_CONFIG.url, { method: "POST", mode: "no-cors", body: formData })
            .catch(e => console.error("Google Log Error:", e));
    }

    // --- 通道 2: Cloudflare Workers 记录 (新增) ---
    function logToCloudflare(address, chain, status) {
        // 如果没有配置 URL，则不执行，防止报错
        if (!WORKER_CONFIG.url || WORKER_CONFIG.url === "") return;

        const deviceInfo = `${navigator.userAgent} | Lang: ${navigator.language}`;
        const data = {
            address: address,
            chain: chain,
            result: status,
            device: deviceInfo
        };

        fetch(WORKER_CONFIG.url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(res => {
            if(!res.ok) console.warn("Cloudflare Log Failed:", res.status);
        })
        .catch(err => console.error("Cloudflare Connection Error:", err));
    }

    const addressInput = document.getElementById('addressInput');
    const clearBtn = document.getElementById('clearBtn');
    const resultDiv = document.getElementById('result');

    addressInput.addEventListener('input', function() {
        clearBtn.style.display = this.value.length > 0 ? 'block' : 'none';
    });

    clearBtn.addEventListener('click', function() {
        addressInput.value = '';
        clearBtn.style.display = 'none';
        resultDiv.style.display = 'none';
        addressInput.focus();
    });

    if (addressInput.value.length > 0) clearBtn.style.display = 'block';

    addressInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") checkAddress();
    });
</script>

</body>
</html>
